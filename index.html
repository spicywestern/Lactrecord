<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BabyFlow FIX v10</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-4">

    <div class="max-w-md mx-auto space-y-4">
        <div class="bg-white p-6 rounded-[2rem] shadow-sm flex justify-between items-center">
            <h1 class="text-2xl font-black text-pink-600">Martina</h1>
            <div class="text-right">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Siguiente</p>
                <p id="clock" class="text-xl font-mono font-bold">--:--:--</p>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="setH(1)" class="h-btn flex-1 bg-white p-3 rounded-xl text-xs font-bold border">1h</button>
            <button onclick="setH(2)" class="h-btn flex-1 bg-white p-3 rounded-xl text-xs font-bold border">2h</button>
            <button onclick="setH(3)" class="h-btn flex-1 bg-slate-800 text-white p-3 rounded-xl text-xs font-bold">3h</button>
        </div>

        <div class="bg-white p-8 rounded-[3rem] shadow-xl text-center">
            <div id="ui-espera" class="flex gap-4">
                <button onclick="empezar('Izq')" class="flex-1 py-10 bg-pink-500 text-white rounded-3xl font-bold text-xl">IZQ</button>
                <button onclick="empezar('Der')" class="flex-1 py-10 bg-blue-500 text-white rounded-3xl font-bold text-xl">DER</button>
            </div>
            
            <div id="ui-corriendo" class="hidden">
                <p id="lbl-lado" class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-widest"></p>
                <p id="cronometro" class="text-6xl font-mono font-black mb-6">00:00</p>
                <div class="flex gap-2">
                    <button id="btn-p" onclick="pausa()" class="flex-1 bg-orange-400 text-white py-4 rounded-xl font-bold">PAUSA</button>
                    <button id="btn-r" onclick="resume()" class="flex-1 bg-green-500 text-white py-4 rounded-xl font-bold hidden">SIGUE</button>
                    <button onclick="terminar()" class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-bold">FIN</button>
                </div>
            </div>
        </div>

        <div id="historial" class="space-y-2"></div>
    </div>

    <script>
        // CONFIGURACIÓN (Verifica que tu DatabaseURL sea exactamente esta)
        const firebaseConfig = {
            projectId: "babyflow-11b57",
            databaseURL: "https://babyflow-11b57-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ID_FAMILIA = "MAR123"; // ASEGÚRATE DE USAR TU CÓDIGO AQUÍ

        let tiempo = 0, motor = null, enPausa = false, horasGap = 3, tomaObj = null;

        function setH(n) { horasGap = n; }

        function empezar(lado) {
            // GRABA PRÓXIMA TOMA DESDE EL INICIO
            db.ref(`f/${ID_FAMILIA}/proxima`).set(Date.now() + (horasGap * 3600000));
            
            tiempo = 0; enPausa = false;
            tomaObj = { lado, ini: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) };
            
            document.getElementById('ui-espera').classList.add('hidden');
            document.getElementById('ui-corriendo').classList.remove('hidden');
            document.getElementById('lbl-lado').innerText = "Pecho " + lado;

            motor = setInterval(() => {
                if(!enPausa) {
                    tiempo++;
                    const m = Math.floor(tiempo/60).toString().padStart(2,'0');
                    const s = (tiempo%60).toString().padStart(2,'0');
                    document.getElementById('cronometro').innerText = `${m}:${s}`;
                }
            }, 1000);
        }

        function pausa() { enPausa = true; document.getElementById('btn-p').classList.add('hidden'); document.getElementById('btn-r').classList.remove('hidden'); }
        function resume() { enPausa = false; document.getElementById('btn-r').classList.add('hidden'); document.getElementById('btn-p').classList.remove('hidden'); }

        function terminar() {
            clearInterval(motor);
            const fin = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            db.ref(`f/${ID_FAMILIA}/registros`).push({
                ts: Date.now(),
                dur: Math.max(1, Math.round(tiempo/60)),
                lado: tomaObj.lado,
                intervalo: `${tomaObj.ini} a ${fin}`
            });
            document.getElementById('ui-espera').classList.remove('hidden');
            document.getElementById('ui-corriendo').classList.add('hidden');
        }

        // RELOJ CUENTA REGRESIVA
        setInterval(() => {
            db.ref(`f/${ID_FAMILIA}/proxima`).on('value', s => {
                const t = s.val();
                if(!t) return;
                const d = t - Date.now();
                if(d <= 0) document.getElementById('clock').innerText = "¡TOCA!";
                else {
                    const h = Math.floor(d/3600000), m = Math.floor((d%3600000)/60000), sec = Math.floor((d%60000)/1000);
                    document.getElementById('clock').innerText = `${h}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                }
            });
        }, 1000);

        // LEER HISTORIAL (Realtime)
        db.ref(`f/${ID_FAMILIA}/registros`).on('value', snap => {
            const h = document.getElementById('historial'); h.innerHTML = '';
            const data = snap.val() ? Object.values(snap.val()) : [];
            data.reverse().slice(0,5).forEach(r => {
                h.innerHTML += `<div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center">
                    <div><p class="font-bold">${r.dur} min - ${r.lado}</p><p class="text-[10px] text-slate-400">${r.intervalo}</p></div>
                    <button onclick="borrar('${Object.keys(snap.val())[data.indexOf(r)]}')" class="text-red-300">✕</button>
                </div>`;
            });
        });
    </script>
</body>
</html>
